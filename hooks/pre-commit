#!/usr/bin/env python3
import subprocess
from pathlib import Path

# --- CONFIGURATION ---
# Hardcoded list of subfolders to format (relative to project root)
TARGET_DIRS = ["src", "include", "test"]

# File extensions to format
EXTENSIONS = {".c", ".cpp", ".cc", ".h", ".hpp", ".hh"}

# Path to clang-format executable (can just be "clang-format" if it's in PATH)
CLANG_FORMAT = "clang-format"


def find_git_root(file_path : Path) -> Path:
    try:
        cwd = file_path.parent
        result = subprocess.run(
            ['git', 'rev-parse', '--show-toplevel'],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            check=True,
            text=True,
            cwd=cwd
        )
        path_str = result.stdout.strip()
        if path_str:
            path = Path(path_str)
            if path.is_dir():
                return path
        print("Error: Received an invalid path.")
    except subprocess.CalledProcessError as e:
        print(f"Error: {e.stderr.strip()}")
    return None


def format_files(root: Path):
    for subdir in TARGET_DIRS:
        base = root / subdir
        if not base.exists():
            print(f"[skip] Folder not found: {base}")
            continue
        for file in base.rglob("*"):
            if file.is_file() and file.suffix in EXTENSIONS:
                try:
                    subprocess.run([CLANG_FORMAT, "-i", str(file)], check=True)
                except subprocess.CalledProcessError:
                    print(f"[err] Failed to format: {file}")


if __name__ == "__main__":
    root = find_git_root(Path(__file__))
    if not root:
        print("[err] Not in a Git repository or an error occurred.")
        exit(1)

    format_files(root)
